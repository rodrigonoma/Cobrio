name: Deploy Cobrio to VPS

on:
  push:
    branches:
      - master   # dispara o deploy ao fazer push na branch master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      ##############################################
      # 1ï¸âƒ£ CHECKOUT DO REPOSITÃ“RIO
      ##############################################
      - name: Checkout repository
        uses: actions/checkout@v4

      ##############################################
      # 2ï¸âƒ£ BUILD DO FRONTEND (ANGULAR)
      ##############################################
      - name: Build Angular Frontend
        run: |
          cd cobrio-web
          npm install -g @angular/cli
          npm install --legacy-peer-deps
          ng build --configuration production
        env:
          CI: false

      ##############################################
      # 3ï¸âƒ£ BUILD DO BACKEND (.NET 8)
      ##############################################
      - name: Build .NET Backend
        run: |
          cd src/Cobrio.API
          dotnet restore
          dotnet publish -c Release -o ./publish

      ##############################################
      # 4ï¸âƒ£ LIMPAR DIRETÃ“RIOS ANTIGOS NA VPS
      ##############################################
      - name: Clean old files on VPS
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "ðŸ§¹ Limpando diretÃ³rios antigos..."
            rm -rf /var/www/cobrio/Front/*
            rm -rf /var/www/cobrio/Cobrio.API/*
            mkdir -p /var/www/cobrio/Front
            mkdir -p /var/www/cobrio/Cobrio.API
            echo "âœ… Limpeza concluÃ­da."

      ##############################################
      # 5ï¸âƒ£ UPLOAD DO FRONTEND (ANGULAR)
      ##############################################
      - name: Upload Angular Frontend
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "cobrio-web/dist/**"
          target: "/var/www/cobrio/Front/"

      ##############################################
      # 6ï¸âƒ£ UPLOAD DO BACKEND (.NET)
      ##############################################
      - name: Upload .NET Backend
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "./src/Cobrio.API/publish/*"
          target: "/var/www/cobrio/Cobrio.API/"
          strip_components: 3

      ##############################################
      # 7ï¸âƒ£ AJUSTAR PERMISSÃ•ES NA VPS
      ##############################################
      - name: Fix permissions
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            sudo chown -R www-data:www-data /var/www/cobrio/Cobrio.API
            sudo chmod -R 755 /var/www/cobrio/Cobrio.API
            echo "âœ… PermissÃµes ajustadas."

      ##############################################
      # 8ï¸âƒ£ CRIAR APPSETTINGS DE PRODUCAO USANDO SECRETS
      ##############################################
      - name: Criar appsettings.Production.json no servidor (escapado)
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            echo "ðŸ› ï¸ Gerando appsettings.Production.json..."
            cat > /var/www/cobrio/Cobrio.API/appsettings.Production.json << 'EOF'
            {
              "ConnectionStrings": {
                "DefaultConnection": "${{ secrets.DB_CONNECTION_STRING }}",
                "HangfireConnection": "${{ secrets.HANGFIRE_CONNECTION_STRING }}",
                "RedisConnection": "localhost:6379"
              },
              "JwtSettings": {
                "SecretKey": "${{ secrets.JWT_SECRET_KEY }}",
                "Issuer": "Cobrio.API",
                "Audience": "Cobrio.Web",
                "AccessTokenExpirationMinutes": 15,
                "RefreshTokenExpirationDays": 7
              },
              "Brevo": {
                "ApiKey": "${{ secrets.BREVO_API_KEY }}",
                "FromEmail": "rodrigonoma@gmail.com",
                "FromName": "Cobrio - Sistema de CobranÃ§a"
              },
              "Twilio": {
                "AccountSid": "${{ secrets.TWILIO_ACCOUNT_SID }}",
                "AuthToken": "${{ secrets.TWILIO_AUTH_TOKEN }}",
                "NumeroRemetente": "+5511999999999",
                "NumeroWhatsApp": "+14155238886"
              },
              "Logging": {
                "LogLevel": {
                  "Default": "Information",
                  "Microsoft.AspNetCore": "Warning",
                  "Microsoft.EntityFrameworkCore": "Information"
                }
              },
              "AllowedHosts": "*"
            }
            EOF
            echo "âœ… appsettings.Production.json criado com sucesso!"

      ##############################################
      # 8ï¸âƒ£ REINICIAR API NO PM2
      ##############################################
      - name: Restart PM2 on VPS
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "ðŸš€ Reiniciando API Cobrio..."
            cd /var/www/cobrio/Cobrio.API
            pm2 delete cobrio || true
            pm2 start Cobrio.API.dll --interpreter dotnet --name cobrio
            pm2 save
            echo "âœ… Deploy concluÃ­do com sucesso ðŸš€"

