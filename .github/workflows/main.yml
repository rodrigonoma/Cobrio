name: Deploy Cobrio to VPS

on:
  push:
    branches:
      - master   # altere se a sua branch principal for "main"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      ##############################################
      # 1Ô∏è‚É£ CHECKOUT DO C√ìDIGO
      ##############################################
      - name: Checkout repository
        uses: actions/checkout@v4

      ##############################################
      # 2Ô∏è‚É£ FRONTEND (Angular)
      ##############################################
      - name: Build Angular Frontend
        run: |
          cd cobrio-web
          npm install -g @angular/cli
          npm install --legacy-peer-deps
          ng build --configuration production
        env:
          CI: false

      ##############################################
      # 3Ô∏è‚É£ BACKEND (.NET)
      ##############################################
      - name: Build .NET Backend
        run: |
          cd src/Cobrio.API
          dotnet restore
          dotnet publish -c Release -o publish

      ##############################################
      # 4Ô∏è‚É£ LIMPAR DIRET√ìRIOS ANTIGOS NA VPS
      ##############################################
      - name: Clean target folders on VPS
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "Parando aplica√ß√£o backend..."
            pm2 stop cobrio || true

            echo "Limpando diret√≥rios antigos..."
            rm -rf /var/www/cobrio/Front/*
            rm -rf /var/www/cobrio/Cobrio.API/*

            echo "Diret√≥rios limpos com sucesso."
            mkdir -p /var/www/cobrio/Front
            mkdir -p /var/www/cobrio/Cobrio.API

      ##############################################
      # 5Ô∏è‚É£ UPLOAD DO FRONTEND (Angular)
      ##############################################
      - name: Upload Angular Frontend
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "cobrio-web/dist/**"
          target: "/var/www/cobrio/Front/"
          
      ##############################################
      # 5Ô∏è‚É£ LIMPA ARQUIVOS DO BACKEND
      ##############################################
      - name: Clean old backend files
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "Limpando pasta antiga..."
            rm -rf /var/www/cobrio/Cobrio.API/*

      ##############################################
      # 6Ô∏è‚É£ UPLOAD DO BACKEND (.NET)
      ##############################################
      - name: Upload .NET Backend
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "./src/Cobrio.API/publish/*"
          target: "/var/www/cobrio/Cobrio.API/"
          strip_components: 3

      ##############################################
      # 7Ô∏è‚É£ REINICIAR APLICA√á√ÉO NO PM2
      ##############################################
      - name: Restart PM2 on VPS
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "Reiniciando API Cobrio..."
            cd /var/www/cobrio/Cobrio.API
            pm2 start Cobrio.API.dll --name cobrio || pm2 restart cobrio
            pm2 save

            echo "‚úÖ Deploy conclu√≠do com sucesso üöÄ"
