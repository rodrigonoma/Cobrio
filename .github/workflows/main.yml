name: Deploy Cobrio to VPS

on:
  push:
    branches:
      - master   # dispara o deploy ao fazer push na branch master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      ##############################################
      # 1Ô∏è‚É£ CHECKOUT DO REPOSIT√ìRIO
      ##############################################
      - name: Checkout repository
        uses: actions/checkout@v4

      ##############################################
      # 2Ô∏è‚É£ BUILD DO FRONTEND (ANGULAR)
      ##############################################
      - name: Build Angular Frontend
        run: |
          cd cobrio-web
          npm install -g @angular/cli
          npm install --legacy-peer-deps
          ng build --configuration production
        env:
          CI: false

      ##############################################
      # 3Ô∏è‚É£ BUILD DO BACKEND (.NET 8)
      ##############################################
      - name: Build .NET Backend
        run: |
          cd src/Cobrio.API
          dotnet restore
          dotnet publish -c Release -o ./publish

      ##############################################
      # 4Ô∏è‚É£ LIMPAR DIRET√ìRIOS ANTIGOS NA VPS
      ##############################################
      - name: Clean old files on VPS
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "üßπ Limpando diret√≥rios antigos..."
            rm -rf /var/www/cobrio/Front/*
            rm -rf /var/www/cobrio/Cobrio.API/*
            mkdir -p /var/www/cobrio/Front
            mkdir -p /var/www/cobrio/Cobrio.API
            echo "‚úÖ Limpeza conclu√≠da."

      ##############################################
      # 5Ô∏è‚É£ UPLOAD DO FRONTEND (ANGULAR)
      ##############################################
      - name: Upload Angular Frontend
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "cobrio-web/dist/**"
          target: "/var/www/cobrio/Front/"

      ##############################################
      # 6Ô∏è‚É£ UPLOAD DO BACKEND (.NET)
      ##############################################
      - name: Upload .NET Backend
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "./src/Cobrio.API/publish/*"
          target: "/var/www/cobrio/Cobrio.API/"
          strip_components: 3

      ##############################################
      # 7Ô∏è‚É£ AJUSTAR PERMISS√ïES NA VPS
      ##############################################
      - name: Fix permissions
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            sudo chown -R www-data:www-data /var/www/cobrio/Cobrio.API
            sudo chmod -R 755 /var/www/cobrio/Cobrio.API
            echo "‚úÖ Permiss√µes ajustadas."

      ##############################################
      # 8Ô∏è‚É£ REINICIAR API NO PM2
      ##############################################
      - name: Restart PM2 on VPS
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "üöÄ Reiniciando API Cobrio..."
            cd /var/www/cobrio/Cobrio.API
            pm2 delete cobrio || true
            pm2 start "dotnet Cobrio.API.dll" --name cobrio
            pm2 save
            echo "‚úÖ Deploy conclu√≠do com sucesso üöÄ"
