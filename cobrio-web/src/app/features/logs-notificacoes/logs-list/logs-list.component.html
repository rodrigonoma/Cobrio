<div class="logs-container">
  <div class="card">
    <div class="card-header">
      <h2><i class="pi pi-list"></i> Logs de Notificações</h2>
      <p class="text-muted">Acompanhe o histórico de todas as notificações enviadas</p>
    </div>

    <div class="card-body">
      <!-- Filtros -->
      <div class="filtros-section">
        <div class="filtros-grid">
          <!-- Linha 1: Datas e Status -->
          <div class="filtro-item filtro-data">
            <label for="dataInicio"><i class="pi pi-calendar"></i> Data Início</label>
            <p-calendar
              id="dataInicio"
              [(ngModel)]="dataInicio"
              [showIcon]="true"
              dateFormat="dd/mm/yy"
              placeholder="Selecione..."
              [style]="{'width': '100%'}"
            ></p-calendar>
          </div>

          <div class="filtro-item filtro-data">
            <label for="dataFim"><i class="pi pi-calendar"></i> Data Fim</label>
            <p-calendar
              id="dataFim"
              [(ngModel)]="dataFim"
              [showIcon]="true"
              dateFormat="dd/mm/yy"
              placeholder="Selecione..."
              [style]="{'width': '100%'}"
            ></p-calendar>
          </div>

          <div class="filtro-item filtro-status">
            <label for="status"><i class="pi pi-check-circle"></i> Status</label>
            <p-dropdown
              id="status"
              [(ngModel)]="statusSelecionado"
              [options]="statusOptions"
              optionLabel="label"
              optionValue="value"
              placeholder="Todos"
              [style]="{'width': '100%'}"
            ></p-dropdown>
          </div>

          <!-- Linha 2: Textos de busca -->
          <div class="filtro-item filtro-texto">
            <label for="emailFiltro"><i class="pi pi-envelope"></i> Email</label>
            <input
              pInputText
              id="emailFiltro"
              type="text"
              [(ngModel)]="emailFiltro"
              placeholder="Digite o email..."
              class="p-inputtext-sm"
            />
          </div>

          <div class="filtro-item filtro-texto">
            <label for="cobrancaIdFiltro"><i class="pi pi-tag"></i> ID Cobrança</label>
            <input
              pInputText
              id="cobrancaIdFiltro"
              type="text"
              [(ngModel)]="cobrancaIdFiltro"
              placeholder="ID completo ou parcial..."
              class="p-inputtext-sm"
            />
          </div>

          <div class="filtro-item filtro-texto">
            <label for="regraFiltro"><i class="pi pi-list"></i> Regra</label>
            <input
              pInputText
              id="regraFiltro"
              type="text"
              [(ngModel)]="regraFiltro"
              placeholder="Nome da regra..."
              class="p-inputtext-sm"
            />
          </div>
        </div>

        <div class="filtros-actions">
          <button
            pButton
            label="Filtrar"
            icon="pi pi-filter"
            class="p-button-primary p-button-sm"
            (click)="carregarLogs()"
          ></button>
          <button
            pButton
            label="Limpar"
            icon="pi pi-filter-slash"
            class="p-button-outlined p-button-sm"
            (click)="limparFiltros()"
          ></button>
        </div>
      </div>

      <!-- Tabela -->
      <p-table
        [value]="logs"
        [loading]="loading"
        [paginator]="true"
        [rows]="25"
        [rowsPerPageOptions]="[10, 25, 50, 100]"
        [responsive]="true"
        styleClass="p-datatable-striped"
        [globalFilterFields]="['nomeRegra', 'emailDestinatario', 'telefoneDestinatario', 'statusTexto']"
      >
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 110px">ID Envio</th>
            <th>Data/Hora</th>
            <th>Canal</th>
            <th>Destinatário</th>
            <th>Regra</th>
            <th>Criado Por</th>
            <th>Status</th>
            <th>Aberturas</th>
            <th>Cliques</th>
            <th style="width: 100px">Ações</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-log>
          <tr>
            <td>
              <code class="id-badge" [pTooltip]="log.id" tooltipPosition="top">
                {{ getShortId(log.id) }}
              </code>
            </td>
            <td>
              <div class="data-info">
                <span class="data">{{ log.dataEnvio | date: 'dd/MM/yyyy' }}</span>
                <span class="hora">{{ log.dataEnvio | date: 'HH:mm' }}</span>
              </div>
            </td>
            <td>
              <i [class]="getCanalIcon(log.canalUtilizado)" style="margin-right: 5px"></i>
              {{ log.canalUtilizado }}
            </td>
            <td>
              <div class="destinatario-info">
                <span *ngIf="log.emailDestinatario">
                  <i class="pi pi-envelope"></i> {{ log.emailDestinatario }}
                </span>
                <span *ngIf="log.telefoneDestinatario">
                  <i class="pi pi-mobile"></i> {{ log.telefoneDestinatario }}
                </span>
              </div>
            </td>
            <td>{{ log.nomeRegra }}</td>
            <td>
              <span *ngIf="log.nomeUsuarioCriacao">
                <i class="pi pi-user"></i> {{ log.nomeUsuarioCriacao }}
              </span>
              <span *ngIf="!log.nomeUsuarioCriacao" style="color: #999; font-style: italic;">
                Sistema
              </span>
            </td>
            <td>
              <p-tag
                [severity]="getStatusSeverity(log.status)"
                [value]="log.statusTexto"
                [icon]="getStatusIcon(log.status)"
              ></p-tag>
            </td>
            <td class="text-center">
              <span class="badge" *ngIf="log.quantidadeAberturas > 0">
                {{ log.quantidadeAberturas }}
              </span>
              <span *ngIf="log.quantidadeAberturas === 0">-</span>
            </td>
            <td class="text-center">
              <span class="badge" *ngIf="log.quantidadeCliques > 0">
                {{ log.quantidadeCliques }}
              </span>
              <span *ngIf="log.quantidadeCliques === 0">-</span>
            </td>
            <td>
              <button
                pButton
                icon="pi pi-eye"
                class="p-button-rounded p-button-text p-button-sm"
                pTooltip="Ver detalhes"
                (click)="verDetalhes(log)"
              ></button>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="9" class="text-center">
              <div class="empty-state">
                <i class="pi pi-inbox" style="font-size: 3rem; color: #ccc"></i>
                <p>Nenhum log de notificação encontrado</p>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>
</div>

<!-- Modal de Detalhes -->
<app-log-detail-modal
  *ngIf="selectedLog"
  [(display)]="displayDetalheModal"
  [log]="selectedLog"
></app-log-detail-modal>
