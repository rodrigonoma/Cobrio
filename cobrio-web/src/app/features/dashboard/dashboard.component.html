<div class="dashboard-analytics">
  <!-- Loading Overlay -->
  <div *ngIf="loading" class="flex items-center justify-center py-20">
    <p-progressSpinner></p-progressSpinner>
  </div>

  <!-- Conteúdo do Dashboard -->
  <div *ngIf="!loading">
  <!-- Cabeçalho com Filtros -->
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
    <div>
      <h1 class="text-3xl font-bold mb-2">Dashboard de Cobrança</h1>
      <p class="text-gray-600">Análise completa de réguas e performance de canais</p>
    </div>

    <div class="flex flex-wrap gap-3">
      <p-dropdown
        [options]="periodoOptions"
        [(ngModel)]="periodo"
        optionLabel="label"
        optionValue="value"
        (onChange)="aplicarFiltros()"
        placeholder="Período">
      </p-dropdown>

      <p-dropdown
        [options]="tipoReguaOptions"
        [(ngModel)]="tipoRegua"
        optionLabel="label"
        optionValue="value"
        (onChange)="aplicarFiltros()"
        placeholder="Tipo">
      </p-dropdown>

      <p-dropdown
        [options]="canalOptions"
        [(ngModel)]="canal"
        optionLabel="label"
        optionValue="value"
        (onChange)="aplicarFiltros()"
        placeholder="Canal">
      </p-dropdown>

      <button pButton icon="pi pi-refresh"
        class="p-button-outlined"
        (click)="loadDashboard()"
        [loading]="loading"
        pTooltip="Atualizar dados">
      </button>
    </div>
  </div>

  <!-- 1. KPIs Principais -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <div *ngFor="let kpi of kpis" class="kpi-card">
      <div class="flex items-start justify-between">
        <div class="flex-1">
          <p class="kpi-label">{{ kpi.label }}</p>
          <h3 class="kpi-value">{{ kpi.value }}</h3>
          <p class="kpi-subtitle">{{ kpi.subtitle }}</p>
          <span *ngIf="kpi.trend"
            class="kpi-trend"
            [class.trend-positive]="kpi.trendPositive"
            [class.trend-negative]="!kpi.trendPositive">
            <i [class]="kpi.trendPositive ? 'pi pi-arrow-up' : 'pi pi-arrow-down'"></i>
            {{ kpi.trend }}
          </span>
        </div>
        <div [class]="'kpi-icon ' + kpi.iconBg">
          <i [class]="'pi ' + kpi.icon + ' ' + kpi.iconColor"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- 2. Performance das Réguas -->
  <div class="card mb-6">
    <div class="card-header">
      <h2 class="card-title">
        <i class="pi pi-chart-bar text-blue-600 mr-2"></i>
        Performance das Réguas
      </h2>
      <p class="card-subtitle">Conversão e valor recuperado por régua de cobrança</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Gráfico de Barras -->
      <div>
        <div style="height: 300px;">
          <canvas baseChart
            [data]="performanceReguasChartData"
            [options]="performanceReguasChartOptions"
            type="bar">
          </canvas>
        </div>
      </div>

      <!-- Tabela -->
      <div class="overflow-x-auto">
        <table class="data-table">
          <thead>
            <tr>
              <th>Régua</th>
              <th>Canal</th>
              <th class="text-right">Conv.</th>
              <th class="text-right">Valor</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let regua of performanceReguas">
              <td>
                <div class="font-medium">{{ regua.nome }}</div>
                <div class="text-xs text-gray-500">{{ regua.tipo }}</div>
              </td>
              <td>
                <span class="badge" [ngClass]="{
                  'badge-blue': regua.canal === 'E-mail',
                  'badge-green': regua.canal === 'WhatsApp',
                  'badge-purple': regua.canal === 'SMS'
                }">
                  {{ regua.canal }}
                </span>
              </td>
              <td class="text-right font-semibold">{{ regua.conversao }}%</td>
              <td class="text-right font-semibold text-green-600">
                {{ regua.valorRecuperado > 0 ? formatCurrency(regua.valorRecuperado) : '-' }}
              </td>
            </tr>
            <tr *ngIf="performanceReguas.length === 0">
              <td colspan="4" class="text-center py-8 text-gray-500">
                <i class="pi pi-info-circle mr-2"></i>
                Nenhuma régua com dados no período selecionado
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 3. Efetividade por Canal -->
  <div class="card mb-6">
    <div class="card-header">
      <h2 class="card-title">
        <i class="pi pi-send text-purple-600 mr-2"></i>
        Efetividade por Canal (Omnichannel)
      </h2>
      <p class="card-subtitle">Comparativo de entrega, leitura e resposta</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Gráfico -->
      <div>
        <div style="height: 300px;">
          <canvas baseChart
            [data]="efetividadeCanalChartData"
            [options]="efetividadeCanalChartOptions"
            type="bar">
          </canvas>
        </div>
      </div>

      <!-- Tabela Detalhada -->
      <div class="overflow-x-auto">
        <table class="data-table">
          <thead>
            <tr>
              <th>Canal</th>
              <th class="text-right">Entregues</th>
              <th class="text-right">Lidas</th>
              <th class="text-right">Resp.</th>
              <th class="text-right">Conv.</th>
              <th class="text-right">Custo</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let canal of efetividadeCanais">
              <td class="font-medium">{{ canal.canal }}</td>
              <td class="text-right">{{ canal.entregues.toLocaleString('pt-BR') }}</td>
              <td class="text-right">{{ canal.lidas.toLocaleString('pt-BR') }}</td>
              <td class="text-right">{{ canal.respondidas }}</td>
              <td class="text-right font-semibold text-blue-600">{{ canal.conversao }}%</td>
              <td class="text-right text-sm">R$ {{ canal.custo.toFixed(2) }}</td>
            </tr>
            <tr *ngIf="efetividadeCanais.length === 0">
              <td colspan="6" class="text-center py-8 text-gray-500">
                <i class="pi pi-info-circle mr-2"></i>
                Nenhum canal com dados no período selecionado
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 4. Análise Financeira e ROI -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <!-- KPIs Financeiros -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title text-lg">
          <i class="pi pi-money-bill text-green-600 mr-2"></i>
          Análise Financeira
        </h3>
      </div>

      <div class="space-y-4">
        <div class="financial-metric">
          <span class="metric-label">Total Recuperado (30d)</span>
          <span class="metric-value text-green-600">{{ formatCurrency(analiseFinanceira.totalRecuperado30Dias) }}</span>
        </div>
        <div class="financial-metric">
          <span class="metric-label">Custo de Disparos</span>
          <span class="metric-value">{{ formatCurrency(analiseFinanceira.custoTotalDisparos) }}</span>
        </div>
        <div class="financial-metric">
          <span class="metric-label">ROI Médio</span>
          <span class="metric-value text-blue-600">{{ analiseFinanceira.roiMedio }}x</span>
        </div>
        <div class="financial-metric">
          <span class="metric-label">Ticket Médio Pago</span>
          <span class="metric-value">{{ formatCurrency(analiseFinanceira.ticketMedioPago) }}</span>
        </div>
      </div>
    </div>

    <!-- Gráfico: Valor Recuperado por Dia -->
    <div class="card lg:col-span-2">
      <div class="card-header">
        <h3 class="card-title text-lg">
          <i class="pi pi-chart-line text-green-600 mr-2"></i>
          Evolução do Valor Recuperado
        </h3>
      </div>

      <div style="height: 250px;">
        <canvas baseChart
          [data]="valorRecuperadoChartData"
          [options]="valorRecuperadoChartOptions"
          type="line">
        </canvas>
      </div>
    </div>
  </div>

  <!-- Receita por Tipo de Régua -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="pi pi-chart-pie text-orange-600 mr-2"></i>
          Receita por Tipo de Régua
        </h3>
      </div>

      <div style="height: 300px;">
        <canvas baseChart
          [data]="receitaTipoReguaChartData"
          [options]="receitaTipoReguaChartOptions"
          type="doughnut">
        </canvas>
      </div>
    </div>

    <!-- 5. Engajamento -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="pi pi-users text-indigo-600 mr-2"></i>
          Engajamento e Comportamento
        </h3>
      </div>

      <div class="space-y-4">
        <div class="engagement-item">
          <i class="pi pi-clock text-blue-600"></i>
          <div>
            <div class="engagement-label">Melhor Horário</div>
            <div class="engagement-value">{{ engajamento.melhorHorario || 'N/A' }}</div>
          </div>
        </div>

        <div class="engagement-item">
          <i class="pi pi-calendar text-green-600"></i>
          <div>
            <div class="engagement-label">Melhor Dia da Semana</div>
            <div class="engagement-value">{{ engajamento.melhorDiaSemana || 'N/A' }}</div>
          </div>
        </div>

        <div class="engagement-item">
          <i class="pi pi-star text-yellow-600"></i>
          <div>
            <div class="engagement-label">Canal Mais Engajamento</div>
            <div class="engagement-value">{{ engajamento.canalMaisEngajamento || 'N/A' }}</div>
          </div>
        </div>

        <div class="engagement-item">
          <i class="pi pi-percentage text-purple-600"></i>
          <div>
            <div class="engagement-label">Taxa de Resposta Média</div>
            <div class="engagement-value">N/A</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 6. Status Operacional -->
  <div class="card mb-6">
    <div class="card-header">
      <h2 class="card-title">
        <i class="pi pi-cog text-gray-600 mr-2"></i>
        Status Operacional / Monitoramento
      </h2>
      <p class="card-subtitle">Acompanhamento de integrações e limites de API</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <!-- Fila de Envio -->
      <div class="status-card" [ngClass]="'status-' + (statusFilaEnvio.status === 'OK' ? 'success' : 'danger')">
        <div class="flex items-center justify-between mb-2">
          <span class="status-label">Fila de Envio</span>
          <i [class]="'pi text-xl ' + (statusFilaEnvio.status === 'OK' ? 'pi-check-circle text-green-600' : 'pi-exclamation-triangle text-red-600')"></i>
        </div>
        <div class="status-value">{{ statusFilaEnvio.status === 'OK' ? '✅ OK' : '❌ Erro' }}</div>
        <div class="status-time">
          <span *ngIf="statusFilaEnvio.ultimaExecucao">Última execução: {{ formatDateTime(statusFilaEnvio.ultimaExecucao) }}</span>
          <span *ngIf="!statusFilaEnvio.ultimaExecucao">Nenhuma execução recente</span>
        </div>
      </div>

      <!-- Webhook -->
      <div class="status-card" [ngClass]="'status-' + (statusWebhook.status === 'Ativo' ? 'success' : 'danger')">
        <div class="flex items-center justify-between mb-2">
          <span class="status-label">Webhook de Status</span>
          <i [class]="'pi text-xl ' + (statusWebhook.status === 'Ativo' ? 'pi-link text-green-600' : 'pi-times-circle text-red-600')"></i>
        </div>
        <div class="status-value">{{ statusWebhook.status === 'Ativo' ? '✅ Ativo' : '❌ Inativo' }}</div>
        <div class="status-time">
          <span *ngIf="statusWebhook.ultimaAtualizacao">Última atualização: {{ formatDateTime(statusWebhook.ultimaAtualizacao) }}</span>
          <span *ngIf="!statusWebhook.ultimaAtualizacao">Sem atualizações recentes</span>
        </div>
      </div>

      <!-- Provedores -->
      <div *ngFor="let provedor of statusProvedores"
        class="status-card"
        [ngClass]="'status-' + provedor.status">
        <div class="flex items-center justify-between mb-2">
          <span class="status-label">{{ provedor.nome }}</span>
          <i [class]="'pi text-xl ' + (provedor.status === 'warning' ? 'pi-exclamation-triangle text-yellow-600' : 'pi-check-circle text-green-600')"></i>
        </div>
        <div class="status-value">{{ provedor.percentualUtilizado }}% utilizado</div>
        <div class="status-time">{{ provedor.limite }}</div>

        <!-- Barra de Progresso -->
        <div class="progress-bar mt-2">
          <div class="progress-fill"
            [style.width.%]="provedor.percentualUtilizado"
            [ngClass]="{
              'bg-green-500': provedor.percentualUtilizado < 70,
              'bg-yellow-500': provedor.percentualUtilizado >= 70 && provedor.percentualUtilizado < 90,
              'bg-red-500': provedor.percentualUtilizado >= 90
            }">
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <!-- 7. Timeline de Eventos -->
    <div class="card lg:col-span-2">
      <div class="card-header">
        <h2 class="card-title">
          <i class="pi pi-list text-blue-600 mr-2"></i>
          Timeline de Eventos Recentes
        </h2>
        <p class="card-subtitle">Acompanhamento em tempo real das ações</p>
      </div>

      <div class="timeline">
        <div *ngFor="let evento of eventosTimeline" class="timeline-item">
          <div class="timeline-marker" [ngClass]="'marker-' + evento.severidade">
            <i [class]="'pi ' + evento.icon"></i>
          </div>
          <div class="timeline-content">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <span class="timeline-type">{{ evento.tipo }}</span>
                <p class="timeline-description">{{ evento.descricao }}</p>
                <span *ngIf="evento.valor" class="timeline-value">{{ formatCurrency(evento.valor) }}</span>
              </div>
              <span class="timeline-time">{{ getTempoDecorrido(evento.dataHora) }}</span>
            </div>
          </div>
        </div>
        <div *ngIf="eventosTimeline.length === 0" class="text-center py-8 text-gray-500">
          <i class="pi pi-info-circle mr-2"></i>
          Nenhum evento recente
        </div>
      </div>
    </div>

    <!-- 8. Insights e Recomendações -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">
          <i class="pi pi-lightbulb text-yellow-600 mr-2"></i>
          Insights & Recomendações
        </h2>
        <p class="card-subtitle">Análises automáticas</p>
      </div>

      <div class="space-y-3">
        <div *ngFor="let insight of insights"
          class="insight-card"
          [ngClass]="getInsightColorClass(insight.cor)">
          <div class="flex items-start gap-3">
            <i [class]="'pi ' + insight.icon + ' text-xl ' + getInsightIconColor(insight.cor)"></i>
            <div class="flex-1">
              <h4 class="insight-title">{{ insight.titulo }}</h4>
              <p class="insight-description">{{ insight.descricao }}</p>
              <span class="insight-type">{{ insight.tipo | titlecase }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>
</div>
